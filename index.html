<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tortellini Timer - Focus & Music</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #2c3e50, #1a1a2e);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        .timer-column {
            background: rgba(30, 30, 46, 0.85);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            padding: 30px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #ff9a3c, #ff6b6b);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .tagline {
            color: #aaa;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }
        
        .timer-container {
            text-align: center;
            padding: 30px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .timer {
            font-size: 6rem;
            font-weight: bold;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            color: #ff9a3c;
            text-shadow: 0 0 10px rgba(255, 154, 60, 0.5);
        }
        
        .timer-label {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #ddd;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 25px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-start {
            background: linear-gradient(90deg, #00b09b, #96c93d);
            color: white;
        }
        
        .btn-pause {
            background: linear-gradient(90deg, #ffa500, #ff8c00);
            color: white;
        }
        
        .btn-reset {
            background: linear-gradient(90deg, #8e2de2, #4a00e0);
            color: white;
        }
        
        .btn-skip {
            background: linear-gradient(90deg, #ff416c, #ff4b2b);
            color: white;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        /* Music Player */
        .music-player {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .player-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #4ecdc4;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .play-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #ff9a3c;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .volume-slider {
            flex-grow: 1;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #ff9a3c;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .playlist {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .playlist-item {
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .playlist-item:hover {
            background: rgba(255, 154, 60, 0.1);
        }
        
        .playlist-item.active {
            background: rgba(255, 154, 60, 0.2);
            border-left: 4px solid #ff9a3c;
        }
        
        /* Timer Settings */
        .timer-settings {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .settings-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #ffa500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .time-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }
        
        .time-input {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
        }
        
        .time-input label {
            display: block;
            color: #aaa;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        
        .time-input input {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: white;
            font-size: 1.2rem;
            text-align: center;
        }
        
        /* Tasks Column */
        .tasks-column {
            background: rgba(30, 30, 46, 0.85);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            padding: 30px;
            display: flex;
            flex-direction: column;
        }
        
        .column-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }
        
        .column-title {
            font-size: 2rem;
            color: #4ecdc4;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .points-container {
            background: linear-gradient(90deg, #8e2de2, #4a00e0);
            padding: 10px 20px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .tab {
            padding: 12px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .tab.active {
            border-bottom: 3px solid #ff6b6b;
            color: #ff6b6b;
        }
        
        .tab-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .tab-pane {
            display: none;
            height: 100%;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* Tasks Panel */
        .add-task {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .add-task input {
            flex-grow: 1;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 1.1rem;
        }
        
        .add-task button {
            background: linear-gradient(90deg, #00b09b, #96c93d);
            color: white;
            border-radius: 10px;
            padding: 0 20px;
        }
        
        .task-list {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .task-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s;
            border-left: 4px solid #ff6b6b;
        }
        
        .task-item.completed {
            opacity: 0.7;
            border-left-color: #00b09b;
        }
        
        .task-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
        }
        
        .task-content {
            flex-grow: 1;
        }
        
        .task-title {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .task-description {
            color: #aaa;
            font-size: 0.9rem;
        }
        
        .task-actions {
            display: flex;
            gap: 10px;
        }
        
        .task-actions button {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        /* Rewards Panel */
        .reward-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffa500;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #aaa;
            font-size: 0.9rem;
        }
        
        .rewards-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 25px;
        }
        
        .reward-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #8e2de2;
        }
        
        .reward-info h4 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .reward-info p {
            color: #aaa;
            font-size: 0.9rem;
        }
        
        .reward-cost {
            font-weight: bold;
            color: #ffa500;
            font-size: 1.2rem;
        }
        
        .reward-actions button {
            background: linear-gradient(90deg, #8e2de2, #4a00e0);
            color: white;
            padding: 8px 15px;
        }
        
        .reward-actions button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Sessions */
        .sessions {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 15px;
            padding: 20px;
        }
        
        .session-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #ffa500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .session-counter {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .session-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            flex: 1;
            margin: 0 5px;
        }
        
        .session-item.active {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.5);
        }
        
        .session-type {
            font-size: 1rem;
            margin-bottom: 5px;
            color: #ccc;
        }
        
        .session-count {
            font-size: 2rem;
            font-weight: bold;
        }
        
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .time-inputs {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .timer {
                font-size: 4rem;
            }
            
            .controls, .add-task {
                flex-direction: column;
            }
            
            button, .add-task input {
                width: 100%;
            }
            
            .session-counter {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Timer Column -->
        <div class="timer-column">
            <header>
                <h1><i class="fas fa-pastafarianism"></i> Tortellini Timer</h1>
                <p class="tagline">Focus like an Italian chef cooking perfect pasta!</p>
            </header>
            
            <div class="timer-container">
                <div class="timer-label" id="timerLabel">Work Session</div>
                <div class="timer" id="timer">25:00</div>
            </div>
            
            <div class="controls">
                <button class="btn-start" id="startBtn">
                    <i class="fas fa-play"></i> Start
                </button>
                <button class="btn-pause" id="pauseBtn">
                    <i class="fas fa-pause"></i> Pause
                </button>
                <button class="btn-reset" id="resetBtn">
                    <i class="fas fa-redo"></i> Reset
                </button>
                <button class="btn-skip" id="skipBtn">
                    <i class="fas fa-forward"></i> Skip
                </button>
            </div>
            
            <!-- Timer Settings -->
            <div class="timer-settings">
                <div class="settings-title">
                    <i class="fas fa-cog"></i> Timer Settings
                </div>
                <div class="time-inputs">
                    <div class="time-input">
                        <label for="workTime">Work (minutes)</label>
                        <input type="number" id="workTime" min="1" max="90" value="25">
                    </div>
                    <div class="time-input">
                        <label for="shortBreakTime">Short Break (minutes)</label>
                        <input type="number" id="shortBreakTime" min="1" max="30" value="5">
                    </div>
                    <div class="time-input">
                        <label for="longBreakTime">Long Break (minutes)</label>
                        <input type="number" id="longBreakTime" min="1" max="60" value="15">
                    </div>
                </div>
                <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                    <label for="sessionsBeforeLongBreak" style="color: #aaa;">Sessions before long break:</label>
                    <input type="number" id="sessionsBeforeLongBreak" min="1" max="10" value="4" style="width: 60px; padding: 5px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; color: white; text-align: center;">
                </div>
            </div>
            
            <!-- Music Player -->
            <div class="music-player">
                <div class="player-title">
                    <i class="fas fa-music"></i> Focus Music Playlist
                </div>
                
                <div class="player-controls">
                    <button class="play-btn" id="playPauseBtn">
                        <i class="fas fa-play" id="playIcon"></i>
                    </button>
                    <div style="flex-grow: 1;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span id="currentTrack">Lofi Study Beats</span>
                            <span id="currentTime">0:00</span>
                        </div>
                        <div style="width: 100%; height: 5px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                            <div id="progressBar" style="width: 0%; height: 100%; background: #ff9a3c;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="volume-control">
                    <i class="fas fa-volume-up"></i>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="50">
                    <span id="volumeValue">50%</span>
                </div>
                
                <div class="playlist" id="playlist"></div>
                
                <!-- Streaming Services -->
                <div style="margin-top: 20px;">
                    <div style="font-size: 1.1rem; margin-bottom: 10px; color: #ff9a3c;">
                        <i class="fas fa-external-link-alt"></i> Connect to Streaming
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        <button onclick="openStreaming('spotify')" style="padding: 8px 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; color: white; cursor: pointer;">
                            <i class="fab fa-spotify"></i> Spotify
                        </button>
                        <button onclick="openStreaming('youtube')" style="padding: 8px 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; color: white; cursor: pointer;">
                            <i class="fab fa-youtube"></i> YouTube Music
                        </button>
                        <button onclick="openStreaming('apple')" style="padding: 8px 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 20px; color: white; cursor: pointer;">
                            <i class="fab fa-apple"></i> Apple Music
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Sessions -->
            <div class="sessions">
                <div class="session-title">
                    <i class="fas fa-chart-line"></i> Session Progress
                </div>
                <div class="session-counter">
                    <div class="session-item active" id="workSession">
                        <div class="session-type">Work</div>
                        <div class="session-count" id="workCount">0</div>
                    </div>
                    <div class="session-item" id="shortBreakSession">
                        <div class="session-type">Short Break</div>
                        <div class="session-count" id="shortBreakCount">0</div>
                    </div>
                    <div class="session-item" id="longBreakSession">
                        <div class="session-type">Long Break</div>
                        <div class="session-count" id="longBreakCount">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tasks Column -->
        <div class="tasks-column">
            <div class="column-header">
                <div class="column-title">
                    <i class="fas fa-tasks"></i> Task & Reward System
                </div>
                <div class="points-container">
                    <i class="fas fa-coins"></i>
                    <span id="pointsTotal">0</span> Points
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="tasks">Tasks</div>
                <div class="tab" data-tab="rewards">Rewards</div>
                <div class="tab" data-tab="stats">Statistics</div>
            </div>
            
            <div class="tab-content">
                <!-- Tasks Panel -->
                <div class="tab-pane active" id="tasks-pane">
                    <div class="add-task">
                        <input type="text" id="taskInput" placeholder="Enter a new task...">
                        <button id="addTaskBtn">
                            <i class="fas fa-plus"></i> Add Task
                        </button>
                    </div>
                    
                    <div class="task-list" id="taskList"></div>
                </div>
                
                <!-- Rewards Panel -->
                <div class="tab-pane" id="rewards-pane">
                    <div class="rewards-list" id="rewardsList"></div>
                </div>
                
                <!-- Statistics Panel -->
                <div class="tab-pane" id="stats-pane">
                    <div class="reward-stats">
                        <div class="stat-box">
                            <div class="stat-value" id="totalTasksCompleted">0</div>
                            <div class="stat-label">Tasks Completed</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="totalPomodoros">0</div>
                            <div class="stat-label">Tortellinis Completed</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="totalPointsEarned">0</div>
                            <div class="stat-label">Points Earned</div>
                        </div>
                    </div>
                    <div style="background: rgba(255,107,107,0.1); border-radius: 15px; padding: 20px; margin-top: 20px; border: 1px solid rgba(255,107,107,0.3);">
                        <div style="color: #ffa500; font-size: 1.2rem; margin-bottom: 10px;">
                            <i class="fas fa-trophy"></i> Achievement Summary
                        </div>
                        <div id="achievementSummary" style="font-size: 1.1rem; font-style: italic; color: #ddd;">
                            Complete your first task to see achievements!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==============================
        // GLOBAL STATE
        // ==============================
        let timerInterval;
        let isRunning = false;
        let isWorkSession = true;
        let workSessionsCompleted = 0;
        let totalPoints = 0;
        let totalTasksCompleted = 0;
        let totalPointsEarned = 0;
        
        // Timer settings with localStorage support
        let timerSettings = {
            workTime: 25,
            shortBreakTime: 5,
            longBreakTime: 15,
            sessionsBeforeLongBreak: 4
        };
        
        let timeLeft = timerSettings.workTime * 60;

        // ==============================
        // TORTELLINI TIMER WITH SETTINGS
        // ==============================
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateDisplay() {
            document.getElementById('timer').textContent = formatTime(timeLeft);
        }

        function loadTimerSettings() {
            const savedSettings = localStorage.getItem('tortelliniTimerSettings');
            if (savedSettings) {
                timerSettings = JSON.parse(savedSettings);
            }
            
            // Update input fields
            document.getElementById('workTime').value = timerSettings.workTime;
            document.getElementById('shortBreakTime').value = timerSettings.shortBreakTime;
            document.getElementById('longBreakTime').value = timerSettings.longBreakTime;
            document.getElementById('sessionsBeforeLongBreak').value = timerSettings.sessionsBeforeLongBreak;
            
            // Reset timer with new settings
            resetTimer();
        }

        function saveTimerSettings() {
            timerSettings.workTime = parseInt(document.getElementById('workTime').value) || 25;
            timerSettings.shortBreakTime = parseInt(document.getElementById('shortBreakTime').value) || 5;
            timerSettings.longBreakTime = parseInt(document.getElementById('longBreakTime').value) || 15;
            timerSettings.sessionsBeforeLongBreak = parseInt(document.getElementById('sessionsBeforeLongBreak').value) || 4;
            
            localStorage.setItem('tortelliniTimerSettings', JSON.stringify(timerSettings));
            
            // Reset timer with new settings
            resetTimer();
            showNotification("Timer settings saved!", "success");
        }

        function startTimer() {
            if (isRunning) return;
            
            isRunning = true;
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            
            timerInterval = setInterval(() => {
                timeLeft--;
                updateDisplay();
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    isRunning = false;
                    sessionComplete();
                }
            }, 1000);
        }

        function pauseTimer() {
            if (!isRunning) return;
            
            clearInterval(timerInterval);
            isRunning = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
        }

        function resetTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            
            if (isWorkSession) {
                timeLeft = timerSettings.workTime * 60;
                document.getElementById('timerLabel').textContent = "Work Session";
                updateSessionHighlight(true, false, false);
            } else {
                if (workSessionsCompleted > 0 && workSessionsCompleted % timerSettings.sessionsBeforeLongBreak === 0) {
                    timeLeft = timerSettings.longBreakTime * 60;
                    document.getElementById('timerLabel').textContent = "Long Break";
                    updateSessionHighlight(false, false, true);
                } else {
                    timeLeft = timerSettings.shortBreakTime * 60;
                    document.getElementById('timerLabel').textContent = "Short Break";
                    updateSessionHighlight(false, true, false);
                }
            }
            
            updateDisplay();
        }

        function skipSession() {
            pauseTimer();
            sessionComplete();
        }

        function sessionComplete() {
            playNotificationSound();
            
            if (isWorkSession) {
                workSessionsCompleted++;
                document.getElementById('workCount').textContent = workSessionsCompleted;
                isWorkSession = false;
                addPoints(5); // 5 points for completing work session
                
                if (workSessionsCompleted % timerSettings.sessionsBeforeLongBreak === 0) {
                    showNotification("Work session completed! Time for a long break! ðŸ", "success");
                } else {
                    showNotification("Work session completed! Time for a short break! ðŸŽµ", "success");
                }
            } else {
                isWorkSession = true;
                showNotification("Break is over! Back to work! ðŸ’ª", "info");
            }
            
            resetTimer();
            updateStats();
            saveToLocalStorage();
        }

        function updateSessionHighlight(workActive, shortBreakActive, longBreakActive) {
            document.getElementById('workSession').classList.toggle('active', workActive);
            document.getElementById('shortBreakSession').classList.toggle('active', shortBreakActive);
            document.getElementById('longBreakSession').classList.toggle('active', longBreakActive);
        }

        // ==============================
        // MUSIC PLAYER - FIXED VOLUME
        // ==============================
        let isPlaying = false;
        let currentTrackIndex = 0;
        let audioElement = null;
        let volume = 0.5; // Default volume (50%)

        const focusPlaylist = [
            {
                title: "Nature Sounds",
                artist: "Calm Forest",
                audioUrl: "https://assets.mixkit.co/music/preview/mixkit-tree-of-life-583.mp3",
                youtubeUrl: "https://www.youtube.com/watch?v=DWcJFNfaw9c"
            },
            {
                title: "Lofi Study Beats",
                artist: "Chillhop Music",
                audioUrl: "https://assets.mixkit.co/music/preview/mixkit-driving-ambition-32.mp3",
                youtubeUrl: "https://www.youtube.com/watch?v=jfKfPfyJRdk"
            },
            {
                title: "Deep Focus Flow",
                artist: "Study Music",
                audioUrl: "https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-130.mp3",
                youtubeUrl: "https://www.youtube.com/watch?v=4PTBx8ZbH1M"
            },
            {
                title: "Alpha Waves",
                artist: "Meditative Mind",
                audioUrl: "https://assets.mixkit.co/music/preview/mixkit-deep-urban-623.mp3",
                youtubeUrl: "https://www.youtube.com/watch?v=wzjWIxXBs_s"
            }
        ];

        function initMusicPlayer() {
            renderPlaylist();
            
            // Create audio element with working URLs
            audioElement = new Audio();
            audioElement.volume = volume; // Set initial volume
            audioElement.preload = "auto";
            
            // Load first track
            loadTrack(currentTrackIndex);
            
            // Event listeners
            document.getElementById('playPauseBtn').addEventListener('click', togglePlayPause);
            document.getElementById('volumeSlider').addEventListener('input', updateVolume);
            
            // Audio events
            audioElement.addEventListener('timeupdate', updateProgress);
            audioElement.addEventListener('ended', nextTrack);
            audioElement.addEventListener('error', (e) => {
                console.log("Audio error:", e);
                showNotification("Audio error. Click the YouTube link for music.", "info");
            });
            
            // Set initial volume display
            document.getElementById('volumeSlider').value = volume * 100;
            document.getElementById('volumeValue').textContent = `${Math.round(volume * 100)}%`;
        }

        function renderPlaylist() {
            const playlistEl = document.getElementById('playlist');
            playlistEl.innerHTML = '';
            
            focusPlaylist.forEach((track, index) => {
                const item = document.createElement('div');
                item.className = `playlist-item ${index === currentTrackIndex ? 'active' : ''}`;
                item.innerHTML = `
                    <i class="fas fa-music"></i>
                    <div style="flex-grow: 1;">
                        <div style="font-weight: 600;">${track.title}</div>
                        <div style="font-size: 0.8rem; color: #aaa;">${track.artist}</div>
                    </div>
                    <i class="fas fa-external-link-alt" onclick="openTrackLink('${track.youtubeUrl}')"></i>
                `;
                
                item.addEventListener('click', () => {
                    selectTrack(index);
                });
                
                playlistEl.appendChild(item);
            });
        }

        function loadTrack(index) {
            currentTrackIndex = index;
            const track = focusPlaylist[index];
            
            document.getElementById('currentTrack').textContent = `${track.title} - ${track.artist}`;
            
            if (audioElement) {
                audioElement.pause();
                audioElement.src = track.audioUrl;
                audioElement.load();
                audioElement.volume = volume; // Maintain volume setting
                
                if (isPlaying) {
                    audioElement.play().catch(e => {
                        console.log("Play error:", e);
                        isPlaying = false;
                        document.getElementById('playIcon').className = 'fas fa-play';
                    });
                }
            }
            
            // Update active track
            document.querySelectorAll('.playlist-item').forEach((item, i) => {
                item.classList.toggle('active', i === index);
            });
        }

        function togglePlayPause() {
            if (isPlaying) {
                pauseMusic();
            } else {
                playMusic();
            }
        }

        function playMusic() {
            if (!audioElement.src) {
                loadTrack(currentTrackIndex);
            }
            
            audioElement.play().then(() => {
                isPlaying = true;
                document.getElementById('playIcon').className = 'fas fa-pause';
                document.getElementById('playPauseBtn').style.background = '#ff6b6b';
                showNotification(`Now playing: ${focusPlaylist[currentTrackIndex].title}`, "info");
            }).catch(error => {
                console.log("Playback failed:", error);
                showNotification("Click the YouTube icon to listen on YouTube", "info");
            });
        }

        function pauseMusic() {
            audioElement.pause();
            isPlaying = false;
            document.getElementById('playIcon').className = 'fas fa-play';
            document.getElementById('playPauseBtn').style.background = '#ff9a3c';
        }

        function selectTrack(index) {
            pauseMusic();
            loadTrack(index);
            playMusic();
        }

        function nextTrack() {
            const nextIndex = (currentTrackIndex + 1) % focusPlaylist.length;
            selectTrack(nextIndex);
        }

        function updateProgress() {
            if (!audioElement.duration || isNaN(audioElement.duration)) return;
            
            const progress = (audioElement.currentTime / audioElement.duration) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            const minutes = Math.floor(audioElement.currentTime / 60);
            const seconds = Math.floor(audioElement.currentTime % 60);
            document.getElementById('currentTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateVolume() {
            const slider = document.getElementById('volumeSlider');
            volume = slider.value / 100;
            document.getElementById('volumeValue').textContent = `${slider.value}%`;
            
            if (audioElement) {
                audioElement.volume = volume;
                console.log("Volume set to:", volume); // Debug log
            }
        }

        function openTrackLink(url) {
            window.open(url, '_blank');
        }

        // ==============================
        // TASK & REWARD SYSTEM
        // ==============================
        let tasks = [];
        let rewards = [
            { id: 1, name: "Coffee Break", description: "Enjoy a 15-minute coffee break", cost: 10, claimed: false },
            { id: 2, name: "Watch a Video", description: "Watch a 10-minute fun video", cost: 15, claimed: false },
            { id: 3, name: "Snack Time", description: "Have a healthy snack", cost: 20, claimed: false },
            { id: 4, name: "Short Walk", description: "Take a 10-minute walk outside", cost: 25, claimed: false }
        ];

        function initTaskSystem() {
            loadFromLocalStorage();
            renderTasks();
            renderRewards();
            updatePointsDisplay();
            updateStats();
            
            // Event listeners
            document.getElementById('addTaskBtn').addEventListener('click', addTask);
            document.getElementById('taskInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask();
            });
            
            // Tab functionality
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                    document.getElementById(`${tabId}-pane`).classList.add('active');
                });
            });
            
            // Timer settings event listeners
            document.getElementById('workTime').addEventListener('change', saveTimerSettings);
            document.getElementById('shortBreakTime').addEventListener('change', saveTimerSettings);
            document.getElementById('longBreakTime').addEventListener('change', saveTimerSettings);
            document.getElementById('sessionsBeforeLongBreak').addEventListener('change', saveTimerSettings);
        }

        function addTask() {
            const taskInput = document.getElementById('taskInput');
            const taskTitle = taskInput.value.trim();
            if (!taskTitle) return;
            
            const newTask = {
                id: Date.now(),
                title: taskTitle,
                description: "",
                points: Math.floor(Math.random() * 15) + 5,
                completed: false
            };
            
            tasks.unshift(newTask);
            taskInput.value = "";
            
            renderTasks();
            showNotification("Task added successfully!", "success");
            saveToLocalStorage();
        }

        function toggleTask(taskId) {
            const taskIndex = tasks.findIndex(task => task.id === taskId);
            if (taskIndex === -1) return;
            
            const task = tasks[taskIndex];
            task.completed = !task.completed;
            
            if (task.completed) {
                addPoints(task.points);
                totalTasksCompleted++;
                showNotification(`Task completed! You earned ${task.points} points!`, "success");
            } else {
                addPoints(-task.points);
                totalTasksCompleted--;
            }
            
            renderTasks();
            updateStats();
            saveToLocalStorage();
        }

        function deleteTask(taskId) {
            tasks = tasks.filter(task => task.id !== taskId);
            renderTasks();
            showNotification("Task deleted.", "info");
            saveToLocalStorage();
        }

        function renderTasks() {
            const taskListEl = document.getElementById('taskList');
            taskListEl.innerHTML = '';
            
            if (tasks.length === 0) {
                taskListEl.innerHTML = '<div class="task-item" style="text-align: center; justify-content: center; color: #aaa;">No tasks yet. Add your first task!</div>';
                return;
            }
            
            tasks.forEach(task => {
                const taskItem = document.createElement('div');
                taskItem.className = `task-item ${task.completed ? 'completed' : ''}`;
                taskItem.innerHTML = `
                    <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''} onclick="toggleTask(${task.id})">
                    <div class="task-content">
                        <div class="task-title">${task.title}</div>
                        <div class="task-description">${task.description || 'No description'}</div>
                        <div style="color: #ffa500; font-size: 0.8rem;">
                            <i class="fas fa-coins"></i> ${task.points} points
                        </div>
                    </div>
                    <div class="task-actions">
                        <button onclick="deleteTask(${task.id})" style="padding: 8px; background: #ff416c;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                taskListEl.appendChild(taskItem);
            });
        }

        function renderRewards() {
            const rewardsListEl = document.getElementById('rewardsList');
            rewardsListEl.innerHTML = '';
            
            rewards.forEach(reward => {
                const rewardItem = document.createElement('div');
                rewardItem.className = 'reward-item';
                rewardItem.innerHTML = `
                    <div class="reward-info">
                        <h4>${reward.name}</h4>
                        <p>${reward.description}</p>
                    </div>
                    <div class="reward-cost">
                        <i class="fas fa-coins"></i> ${reward.cost}
                    </div>
                    <div class="reward-actions">
                        <button onclick="claimReward(${reward.id})" ${reward.claimed || totalPoints < reward.cost ? 'disabled' : ''}>
                            ${reward.claimed ? 'Claimed' : 'Claim'}
                        </button>
                    </div>
                `;
                rewardsListEl.appendChild(rewardItem);
            });
        }

        function claimReward(rewardId) {
            const rewardIndex = rewards.findIndex(reward => reward.id === rewardId);
            if (rewardIndex === -1) return;
            
            const reward = rewards[rewardIndex];
            
            if (totalPoints < reward.cost) {
                showNotification(`Not enough points! You need ${reward.cost} points.`, "info");
                return;
            }
            
            if (reward.claimed) {
                showNotification("Reward already claimed!", "info");
                return;
            }
            
            addPoints(-reward.cost);
            rewards[rewardIndex].claimed = true;
            
            showNotification(`You claimed: ${reward.name}! Enjoy your reward!`, "success");
            
            renderRewards();
            saveToLocalStorage();
        }

        function addPoints(amount) {
            totalPoints += amount;
            if (amount > 0) {
                totalPointsEarned += amount;
            }
            updatePointsDisplay();
            updateStats();
            saveToLocalStorage();
        }

        function updatePointsDisplay() {
            document.getElementById('pointsTotal').textContent = totalPoints;
        }

        function updateStats() {
            document.getElementById('totalTasksCompleted').textContent = totalTasksCompleted;
            document.getElementById('totalPomodoros').textContent = workSessionsCompleted;
            document.getElementById('totalPointsEarned').textContent = totalPointsEarned;
            
            // Update achievement summary
            let summary = "";
            if (totalTasksCompleted === 0) {
                summary = "Complete your first task to see achievements!";
            } else if (totalTasksCompleted < 3) {
                summary = `Great start! ${totalTasksCompleted} task${totalTasksCompleted > 1 ? 's' : ''} completed.`;
            } else if (totalTasksCompleted < 10) {
                summary = `Awesome! ${totalTasksCompleted} tasks completed!`;
            } else {
                summary = `Incredible! ${totalTasksCompleted} tasks done! You're a productivity master!`;
            }
            document.getElementById('achievementSummary').textContent = summary;
        }

        // ==============================
        // UTILITIES
        // ==============================
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                // Silent fail if audio not supported
            }
        }

        function showNotification(message, type = "info") {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: ${type === 'success' ? '#00b09b' : type === 'info' ? '#4a00e0' : '#ff6b6b'};
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
            
            // Add animation styles
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function openStreaming(service) {
            const links = {
                spotify: "https://open.spotify.com/genre/0JQ5DAqbMKFEC4WFtoNRpw",
                youtube: "https://music.youtube.com/",
                apple: "https://music.apple.com/us/browse"
            };
            
            if (links[service]) {
                window.open(links[service], '_blank');
            }
        }

        // ==============================
        // LOCAL STORAGE
        // ==============================
        function saveToLocalStorage() {
            const data = {
                tasks: tasks,
                rewards: rewards,
                totalPoints: totalPoints,
                totalTasksCompleted: totalTasksCompleted,
                totalPointsEarned: totalPointsEarned,
                workSessionsCompleted: workSessionsCompleted
            };
            localStorage.setItem('tortelliniTimerData', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('tortelliniTimerData');
            if (savedData) {
                const data = JSON.parse(savedData);
                tasks = data.tasks || [];
                rewards = data.rewards || rewards;
                totalPoints = data.totalPoints || 0;
                totalTasksCompleted = data.totalTasksCompleted || 0;
                totalPointsEarned = data.totalPointsEarned || 0;
                workSessionsCompleted = data.workSessionsCompleted || 0;
                
                // Update counts
                document.getElementById('workCount').textContent = workSessionsCompleted;
            }
        }

        // ==============================
        // INITIALIZATION
        // ==============================
        window.onload = function() {
            // Load timer settings
            loadTimerSettings();
            updateDisplay();
            
            // Initialize music player
            initMusicPlayer();
            
            // Initialize task system
            initTaskSystem();
            
            // Set up timer controls
            document.getElementById('startBtn').addEventListener('click', startTimer);
            document.getElementById('pauseBtn').addEventListener('click', pauseTimer);
            document.getElementById('resetBtn').addEventListener('click', resetTimer);
            document.getElementById('skipBtn').addEventListener('click', skipSession);
            
            // Disable pause button initially
            document.getElementById('pauseBtn').disabled = true;
            
            console.log("Tortellini Timer initialized successfully!");
        };

        // Make functions available globally
        window.toggleTask = toggleTask;
        window.deleteTask = deleteTask;
        window.claimReward = claimReward;
        window.openTrackLink = openTrackLink;
        window.openStreaming = openStreaming;
    </script>
</body>
</html>
